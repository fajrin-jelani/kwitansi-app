<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kwitansi Pembayaran</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;family=Outfit:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    .font-heading {
      font-family: 'Space Grotesk', system-ui, sans-serif;
    }
    .font-body {
      font-family: 'Outfit', system-ui, sans-serif;
    }
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
    }
    .receipt-pattern {
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .gradient-text {
      background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(99, 102, 241, 0.2);
    }
    .stat-card {
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 100%);
      pointer-events: none;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fade-in {
      animation: fadeInUp 0.5s ease-out forwards;
    }
    .pulse-dot {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full font-body">
  <div id="app" class="h-full w-full overflow-auto" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);"><!-- Main Container -->
   <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8"><!-- Header -->
    <div class="text-center mb-8">
     <div class="flex items-center justify-center gap-4 mb-3">
      <div class="p-3 rounded-2xl glass-effect"><span class="text-4xl">üíé</span>
      </div>
      <h1 id="main-title" class="font-heading text-4xl sm:text-5xl font-bold gradient-text"><span id="title-text">Kwitansi Pembayaran</span></h1><button onclick="toggleSettings()" class="p-3 rounded-2xl glass-effect transition-all hover:scale-110 hover:rotate-90" title="Pengaturan"> <span class="text-2xl">‚öôÔ∏è</span> </button>
     </div>
     <p class="text-white text-base font-medium">Kelola kwitansi pembayaran dengan mudah dan modern ‚ú®</p>
    </div><!-- Stats Dashboard -->
    <div id="stats-dashboard" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8 no-print"><!-- Total Kwitansi -->
     <div class="stat-card glass-effect rounded-2xl p-6 card-hover" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(99, 102, 241, 0.1) 100%); border: 1px solid rgba(99, 102, 241, 0.3);">
      <div class="flex items-center justify-between mb-2"><span class="text-3xl">üìã</span>
       <div class="w-2 h-2 rounded-full bg-indigo-400 pulse-dot"></div>
      </div>
      <div class="text-white text-3xl font-bold font-heading mb-1" id="total-receipts">
       0
      </div>
      <div class="text-white text-sm font-medium">
       Total Kwitansi
      </div>
     </div><!-- Total Nilai -->
     <div class="stat-card glass-effect rounded-2xl p-6 card-hover" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.3) 0%, rgba(168, 85, 247, 0.1) 100%); border: 1px solid rgba(168, 85, 247, 0.3);">
      <div class="flex items-center justify-between mb-2"><span class="text-3xl">ÔøΩÔøΩ</span>
       <div class="w-2 h-2 rounded-full bg-purple-400 pulse-dot"></div>
      </div>
      <div class="text-white text-2xl font-bold font-heading mb-1" id="total-amount">
       Rp 0
      </div>
      <div class="text-white text-sm font-medium">
       Total Nilai
      </div>
     </div><!-- Kwitansi Terbaru -->
     <div class="stat-card glass-effect rounded-2xl p-6 card-hover" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.1) 100%); border: 1px solid rgba(59, 130, 246, 0.3);">
      <div class="flex items-center justify-between mb-2"><span class="text-3xl">‚ö°</span>
       <div class="w-2 h-2 rounded-full bg-blue-400 pulse-dot"></div>
      </div>
      <div class="text-white text-2xl font-bold font-heading mb-1" id="latest-receipt">
       -
      </div>
      <div class="text-white text-sm font-medium">
       Terbaru
      </div>
     </div>
    </div><!-- Settings Panel -->
    <div id="settings-panel" class="hidden no-print rounded-3xl shadow-2xl p-6 mb-8 glass-effect animate-fade-in">
     <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3"><span class="text-3xl">‚öôÔ∏è</span>
       <h2 class="font-heading text-2xl font-semibold text-white">Pengaturan</h2>
      </div><button onclick="toggleSettings()" class="text-2xl text-slate-300 hover:text-white transition-all hover:rotate-90">‚úï</button>
     </div>
     <form id="settings-form" class="space-y-5">
      <div><label for="settings-title" class="block text-sm font-semibold mb-2 text-white">Judul Kwitansi</label> <input type="text" id="settings-title" class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="Kwitansi Pembayaran">
      </div>
      <div><label for="settings-company" class="block text-sm font-semibold mb-2 text-white">Nama Perusahaan / PT</label> <input type="text" id="settings-company" class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="PT. MAJU BERSAMA">
      </div>
      <div><label for="settings-address" class="block text-sm font-semibold mb-2 text-white">Alamat Perusahaan</label> <input type="text" id="settings-address" class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="Jl. Raya Utama No. 123, Jakarta">
      </div>
      <div class="pt-4 border-t-2" style="border-color: rgba(255,255,255,0.1);">
       <div class="flex items-center gap-2 mb-4"><span class="text-2xl">‚úçÔ∏è</span>
        <h3 class="font-semibold text-base text-white">Tanda Tangan</h3>
       </div>
       <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div><label for="settings-location" class="block text-sm font-semibold mb-2 text-white">Tempat</label> <input type="text" id="settings-location" class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="Jakarta">
        </div>
        <div><label for="settings-signature-name" class="block text-sm font-semibold mb-2 text-white">Nama Penandatangan</label> <input type="text" id="settings-signature-name" class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="Penerima">
        </div>
       </div>
       <div class="mt-4"><label for="settings-signature-phone" class="block text-sm font-semibold mb-2 text-white">No. HP / Telepon</label> <input type="text" id="settings-signature-phone" class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="081234567890">
       </div>
      </div><button type="submit" class="w-full py-4 px-6 rounded-xl font-semibold text-white transition-all transform hover:scale-[1.02] active:scale-[0.98] font-heading text-lg" style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); box-shadow: 0 8px 24px rgba(99,102,241,0.4);"> üíæ Simpan Pengaturan </button>
     </form>
    </div><!-- Form Input -->
    <div class="no-print rounded-3xl shadow-2xl p-6 mb-8 glass-effect">
     <div class="flex items-center gap-3 mb-6"><span class="text-3xl">‚ú®</span>
      <h2 class="font-heading text-2xl font-semibold text-white">Buat Kwitansi Baru</h2>
     </div>
     <form id="receipt-form" class="space-y-5">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
       <div><label for="diterima-dari" class="block text-sm font-semibold mb-2 text-white">Telah Diterima Dari</label> <input type="text" id="diterima-dari" required class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="Nama pembayar">
       </div>
       <div><label for="uang-sejumlah" class="block text-sm font-semibold mb-2 text-white">Uang Sejumlah (Rp)</label> <input type="number" id="uang-sejumlah" required min="0" class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="0">
       </div>
      </div>
      <div><label for="untuk-pembayaran" class="block text-sm font-semibold mb-2 text-white">Untuk Pembayaran</label> <textarea id="untuk-pembayaran" required rows="2" class="w-full px-4 py-3 rounded-xl border-2 transition-all focus:outline-none resize-none font-body text-white" style="border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.1);" onfocus="this.style.borderColor='#6366f1'; this.style.boxShadow='0 0 0 4px rgba(99,102,241,0.2)'" onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.boxShadow='none'" placeholder="Keterangan pembayaran"></textarea>
      </div><button type="submit" id="submit-btn" class="w-full py-4 px-6 rounded-xl font-semibold text-white transition-all transform hover:scale-[1.02] active:scale-[0.98] font-heading text-lg" style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); box-shadow: 0 8px 24px rgba(99,102,241,0.4);"> <span id="btn-text">‚ú® Buat Kwitansi</span> <span id="btn-loading" class="hidden">ÔøΩÔøΩÔøΩ Menyimpan...</span> </button>
     </form>
     <div id="limit-warning" class="hidden mt-5 p-4 rounded-xl text-center glass-effect" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4);"><span class="text-red-300 font-medium">‚ö†Ô∏è Batas maksimum 999 kwitansi telah tercapai. Hapus beberapa kwitansi untuk membuat yang baru.</span>
     </div>
    </div><!-- Receipt List -->
    <div class="no-print">
     <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3"><span class="text-3xl">üìö</span>
       <h2 class="font-heading text-2xl font-semibold text-white">Daftar Kwitansi</h2>
      </div>
      <div class="flex items-center gap-3"><button id="select-mode-btn" onclick="toggleSelectMode()" class="hidden px-4 py-2.5 rounded-xl font-medium transition-all transform hover:scale-105 active:scale-95 flex items-center gap-2 glass-effect"> <span>‚òëÔ∏è Pilih Kwitansi</span> </button> <button id="print-all-btn" onclick="printAllReceipts()" class="hidden px-4 py-2.5 rounded-xl font-medium text-white transition-all transform hover:scale-105 active:scale-95 flex items-center gap-2" style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); box-shadow: 0 4px 16px rgba(99,102,241,0.4);"> <span>üñ®Ô∏è Cetak Semua</span> </button> <span id="receipt-count" class="text-sm px-4 py-2 rounded-xl font-medium glass-effect text-white">0 kwitansi</span>
      </div>
     </div><!-- Selection Mode Actions -->
     <div id="selection-actions" class="hidden mb-6 p-5 rounded-2xl glass-effect animate-fade-in" style="border: 2px solid rgba(99,102,241,0.5);">
      <div class="flex items-center justify-between flex-wrap gap-4">
       <div class="flex items-center gap-3"><span class="font-medium text-white font-heading text-lg"> <span id="selected-count">0</span> kwitansi dipilih </span> <button onclick="selectAllReceipts()" class="px-4 py-2 text-sm rounded-lg transition-all hover:scale-105 glass-effect text-white font-medium"> Pilih Semua </button> <button onclick="deselectAllReceipts()" class="px-4 py-2 text-sm rounded-lg transition-all hover:scale-105 glass-effect text-white font-medium"> Batal Pilih </button>
       </div>
       <div class="flex items-center gap-2"><button onclick="printSelectedReceipts()" id="print-selected-btn" class="px-5 py-2.5 rounded-xl font-medium text-white transition-all transform hover:scale-105 active:scale-95 flex items-center gap-2" style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); box-shadow: 0 4px 16px rgba(99,102,241,0.4);"> üñ®Ô∏è Cetak Terpilih </button> <button onclick="toggleSelectMode()" class="px-5 py-2.5 rounded-xl font-medium transition-all text-white" style="background: rgba(239, 68, 68, 0.3); border: 1px solid rgba(239, 68, 68, 0.5);"> ‚úï Tutup </button>
       </div>
      </div>
     </div>
     <div id="receipt-list" class="space-y-4">
      <div id="empty-state" class="text-center py-16 rounded-3xl glass-effect">
       <div class="text-6xl mb-4">
        üì≠
       </div>
       <p class="text-white text-lg font-bold">Belum ada kwitansi</p>
       <p class="text-white text-sm mt-2">Buat kwitansi pertama Anda sekarang! ‚ú®</p>
      </div>
     </div>
    </div><!-- Print Preview (Hidden by default) -->
    <div id="print-preview" class="hidden print-only">
    </div>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      kwitansi_title: 'Kwitansi Pembayaran Sewa Petak',
      company_name: 'Fadjrin',
      company_address: 'Pasar Komura, Mangkupalas',
      signature_location: 'Samarinda seberang',
      signature_name: 'Fadjrin',
      signature_phone: '082351123433',
      primary_color: '#2d2520',
      secondary_color: '#fffdf9',
      text_color: '#4a3f35',
      accent_color: '#8b7355',
      border_color: '#d4c4b0'
    };

    // Load saved config from localStorage or use default
    function loadSavedConfig() {
      try {
        const saved = localStorage.getItem('kwitansi_config');
        if (saved) {
          const parsed = JSON.parse(saved);
          return { ...defaultConfig, ...parsed };
        }
      } catch (e) {
        console.error('Error loading config:', e);
      }
      return { ...defaultConfig };
    }

    // Save config to localStorage
    function saveConfigToStorage(configToSave) {
      try {
        localStorage.setItem('kwitansi_config', JSON.stringify(configToSave));
      } catch (e) {
        console.error('Error saving config:', e);
      }
    }

    let config = loadSavedConfig();
    let receipts = [];
    let currentRecordCount = 0;
    let isSelectMode = false;

    // Data handler for SDK
    const dataHandler = {
      onDataChanged(data) {
        receipts = [...data].sort((a, b) => b.no_seri - a.no_seri);
        currentRecordCount = receipts.length;
        updateReceiptList(receipts);
      }
    };

    // Initialize SDK
    async function initializeApp() {
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error('Failed to initialize data SDK');
          showToast('Gagal menginisialisasi sistem penyimpanan', 'error');
        }
      }
    }

    // Call initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }

    // Toggle select mode
    function toggleSelectMode() {
      isSelectMode = !isSelectMode;
      const checkboxes = document.querySelectorAll('.receipt-checkbox');
      const actionButtons = document.querySelectorAll('.action-buttons');
      const selectionActions = document.getElementById('selection-actions');
      const selectModeBtn = document.getElementById('select-mode-btn');
      const printAllBtn = document.getElementById('print-all-btn');
      
      if (isSelectMode) {
        // Show checkboxes, hide action buttons
        checkboxes.forEach(cb => cb.classList.remove('hidden'));
        actionButtons.forEach(ab => ab.classList.add('hidden'));
        selectionActions.classList.remove('hidden');
        selectModeBtn.style.background = 'linear-gradient(135deg, #6366f1 0%, #a855f7 100%)';
        selectModeBtn.style.color = '#fff';
        selectModeBtn.querySelector('span').textContent = '‚úì Mode Pilih Aktif';
        printAllBtn.classList.add('hidden');
      } else {
        // Hide checkboxes, show action buttons
        checkboxes.forEach(cb => {
          cb.classList.add('hidden');
          cb.checked = false;
        });
        actionButtons.forEach(ab => ab.classList.remove('hidden'));
        selectionActions.classList.add('hidden');
        selectModeBtn.style.background = 'rgba(255,255,255,0.1)';
        selectModeBtn.style.color = '#fff';
        selectModeBtn.querySelector('span').textContent = '‚òëÔ∏è Pilih Kwitansi';
        printAllBtn.classList.remove('hidden');
        updateSelectedCount();
      }
    }

    // Update selected count
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.receipt-checkbox:checked');
      const countSpan = document.getElementById('selected-count');
      countSpan.textContent = checkboxes.length;
    }

    // Select all receipts
    function selectAllReceipts() {
      const checkboxes = document.querySelectorAll('.receipt-checkbox');
      checkboxes.forEach(cb => cb.checked = true);
      updateSelectedCount();
    }

    // Deselect all receipts
    function deselectAllReceipts() {
      const checkboxes = document.querySelectorAll('.receipt-checkbox');
      checkboxes.forEach(cb => cb.checked = false);
      updateSelectedCount();
    }

    // Print selected receipts
    function printSelectedReceipts() {
      const selectedCheckboxes = document.querySelectorAll('.receipt-checkbox:checked');
      
      if (selectedCheckboxes.length === 0) {
        showToast('Pilih minimal satu kwitansi untuk dicetak', 'error');
        return;
      }
      
      const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
      const selectedReceipts = receipts.filter(r => selectedIds.includes(r.__backendId));
      
      if (selectedReceipts.length === 0) return;
      
      const companyName = config.company_name || defaultConfig.company_name;
      const companyAddress = config.company_address || defaultConfig.company_address;
      const signatureLocation = config.signature_location || defaultConfig.signature_location;
      const signatureName = config.signature_name || defaultConfig.signature_name;
      const signaturePhone = config.signature_phone || defaultConfig.signature_phone;
      
      // Generate selected receipts HTML
      const receiptsHTML = selectedReceipts.map(receipt => `
          <div class="receipt">
            <div class="header">
              <h1>${companyName}</h1>
              <p>${companyAddress}</p>
            </div>
            <div class="no-seri">No: ${String(receipt.no_seri).padStart(4, '0')}</div>
            <div class="title">KWITANSI</div>
            <div class="content">
              <div class="row">
                <span class="label">Telah diterima dari</span>
                <span class="value">${receipt.diterima_dari}</span>
              </div>
              <div class="row">
                <span class="label">Uang sejumlah</span>
                <span class="value">${formatCurrency(receipt.uang_sejumlah)}</span>
              </div>
              <div class="terbilang"># ${receipt.terbilang} Rupiah #</div>
              <div class="row">
                <span class="label">Untuk pembayaran</span>
                <span class="value">${receipt.untuk_pembayaran}</span>
              </div>
            </div>
            <div style="text-align: right; margin-top: 8px; font-size: 13px;">
              ${signatureLocation}, ${formatDate(receipt.tanggal)}
            </div>
            <div class="footer">
              <div class="signature">
                <div class="signature-line"></div>
                <span style="font-size: 14px;">${signatureName}</span>
                ${signaturePhone ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">${signaturePhone}</div>` : ''}
              </div>
            </div>
          </div>
      `).join('');
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Kwitansi Terpilih (${selectedReceipts.length} kwitansi)</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Times New Roman', serif; padding: 10px; max-width: 210mm; margin: 0 auto; background: #f5f5f0; }
            .receipt { 
              border: 2px solid #2c5f2d; 
              padding: 12px 16px; 
              width: 100%; 
              display: block; 
              margin-bottom: 10px; 
              box-sizing: border-box;
              background: linear-gradient(135deg, #fef8e7 0%, #fefcf3 50%, #fef8e7 100%);
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .header { 
              text-align: center; 
              border-bottom: 2px solid #2c5f2d; 
              padding-bottom: 6px; 
              margin-bottom: 8px;
              background: linear-gradient(to bottom, #e8f5e9 0%, transparent 100%);
              padding-top: 4px;
            }
            .header h1 { font-size: 16px; margin-bottom: 3px; font-weight: bold; color: #1b4332; }
            .header p { font-size: 14px; color: #2c5f2d; }
            .title { 
              text-align: center; 
              font-size: 20px; 
              font-weight: bold; 
              margin: 8px 0; 
              text-decoration: underline; 
              color: #1b4332;
              text-transform: uppercase;
              letter-spacing: 2px;
            }
            .no-seri { 
              text-align: right; 
              font-size: 13px; 
              margin-bottom: 8px; 
              color: #d32f2f; 
              font-weight: bold;
            }
            .content { margin: 8px 0; }
            .row { display: flex; margin: 5px 0; font-size: 14px; }
            .label { width: 110px; font-weight: bold; color: #1b4332; }
            .value { 
              flex: 1; 
              border-bottom: 1px dotted #2c5f2d; 
              padding-left: 5px; 
              font-size: 14px; 
              color: #000;
            }
            .terbilang { 
              background: linear-gradient(to right, #c8e6c9 0%, #e8f5e9 50%, #c8e6c9 100%); 
              padding: 6px; 
              margin: 8px 0; 
              font-style: italic; 
              text-align: center; 
              font-size: 13px;
              border: 1px dashed #2c5f2d;
              color: #1b4332;
              font-weight: 500;
            }
            .footer { display: flex; justify-content: flex-end; margin-top: 16px; font-size: 14px; }
            .signature { text-align: center; width: 120px; }
            .signature-line { 
              border-bottom: 1px solid #1b4332; 
              height: 40px; 
              margin-bottom: 3px; 
            }
            .print-btn { 
              position: fixed; 
              top: 20px; 
              right: 20px; 
              padding: 12px 24px; 
              background: #2c5f2d; 
              color: white; 
              border: none; 
              border-radius: 8px; 
              font-size: 16px; 
              cursor: pointer; 
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
              z-index: 1000;
            }
            .print-btn:hover { background: #1b4332; }
            .print-btn:active { transform: scale(0.95); }
            @media print {
              .receipt { page-break-after: always; }
              .receipt:last-child { page-break-after: auto; }
              .print-btn { display: none; }
              @page { size: A4; margin: 10mm; }
              body { background: white; }
            }
          </style>
        </head>
        <body>
          <button class="print-btn" id="printBtn">üñ®Ô∏è Cetak ${selectedReceipts.length} Kwitansi</button>
          ${receiptsHTML}
          <script>
            window.onload = function() {
              var btn = document.getElementById('printBtn');
              if (btn) {
                btn.onclick = function(e) {
                  e.preventDefault();
                  window.print();
                  return false;
                };
              }
            };
          <\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    // Toggle settings panel
    function toggleSettings() {
      const panel = document.getElementById('settings-panel');
      const isHidden = panel.classList.contains('hidden');
      
      if (isHidden) {
        // Load current values
        document.getElementById('settings-title').value = config.kwitansi_title || defaultConfig.kwitansi_title;
        document.getElementById('settings-company').value = config.company_name || defaultConfig.company_name;
        document.getElementById('settings-address').value = config.company_address || defaultConfig.company_address;
        document.getElementById('settings-location').value = config.signature_location || defaultConfig.signature_location;
        document.getElementById('settings-signature-name').value = config.signature_name || defaultConfig.signature_name;
        document.getElementById('settings-signature-phone').value = config.signature_phone || defaultConfig.signature_phone;
        panel.classList.remove('hidden');
      } else {
        panel.classList.add('hidden');
      }
    }

    // Convert number to Indonesian words
    function terbilang(angka) {
      const bilangan = ['', 'Satu', 'Dua', 'Tiga', 'Empat', 'Lima', 'Enam', 'Tujuh', 'Delapan', 'Sembilan', 'Sepuluh', 'Sebelas'];
      
      if (angka < 12) {
        return bilangan[angka];
      } else if (angka < 20) {
        return bilangan[angka - 10] + ' Belas';
      } else if (angka < 100) {
        return bilangan[Math.floor(angka / 10)] + ' Puluh ' + bilangan[angka % 10];
      } else if (angka < 200) {
        return 'Seratus ' + terbilang(angka - 100);
      } else if (angka < 1000) {
        return bilangan[Math.floor(angka / 100)] + ' Ratus ' + terbilang(angka % 100);
      } else if (angka < 2000) {
        return 'Seribu ' + terbilang(angka - 1000);
      } else if (angka < 1000000) {
        return terbilang(Math.floor(angka / 1000)) + ' Ribu ' + terbilang(angka % 1000);
      } else if (angka < 1000000000) {
        return terbilang(Math.floor(angka / 1000000)) + ' Juta ' + terbilang(angka % 1000000);
      } else if (angka < 1000000000000) {
        return terbilang(Math.floor(angka / 1000000000)) + ' Miliar ' + terbilang(angka % 1000000000);
      }
      return angka.toString();
    }

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    }

    // Format date
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    // Get next serial number
    function getNextSerialNumber() {
      if (receipts.length === 0) return 1;
      const maxNo = Math.max(...receipts.map(r => r.no_seri || 0));
      return maxNo + 1;
    }

    // Render receipt card
    function createReceiptCard(receipt) {
      const card = document.createElement('div');
      card.className = 'rounded-3xl shadow-2xl overflow-hidden glass-effect card-hover animate-fade-in';
      card.dataset.id = receipt.__backendId;
      
      card.innerHTML = `
        <div class="p-6">
          <div class="flex items-start justify-between mb-5">
            <div class="flex items-start gap-4">
              <input type="checkbox" 
                class="receipt-checkbox hidden w-5 h-5 mt-1 rounded cursor-pointer" 
                data-id="${receipt.__backendId}"
                onchange="updateSelectedCount()"
                style="accent-color: #6366f1;">
              <div>
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-3xl font-heading font-bold gradient-text">No. ${String(receipt.no_seri).padStart(4, '0')}</span>
                  <span class="px-3 py-1.5 text-xs rounded-xl font-medium glass-effect text-white">${formatDate(receipt.tanggal)}</span>
                </div>
                <p class="text-sm text-slate-300 font-medium">${config.company_name || defaultConfig.company_name}</p>
              </div>
            </div>
            <div class="flex gap-2 action-buttons">
              <button onclick="printReceipt('${receipt.__backendId}')" class="p-3 rounded-xl transition-all hover:scale-110 glass-effect" title="Cetak">
                <span class="text-xl">üñ®Ô∏è</span>
              </button>
              <button onclick="confirmDelete('${receipt.__backendId}')" class="delete-btn p-3 rounded-xl transition-all hover:scale-110" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4);" title="Hapus">
                <span class="text-xl">üóëÔ∏è</span>
              </button>
            </div>
          </div>
          
          <div class="space-y-3 text-sm">
            <div class="flex items-start">
              <span class="w-36 font-semibold text-white">Diterima dari</span>
              <span class="flex-1 font-semibold text-white">: ${receipt.diterima_dari}</span>
            </div>
            <div class="flex items-start">
              <span class="w-36 font-semibold text-white">Uang sejumlah</span>
              <span class="flex-1 font-bold gradient-text text-lg">: ${formatCurrency(receipt.uang_sejumlah)}</span>
            </div>
            <div class="flex items-start">
              <span class="w-36 font-semibold text-white">Terbilang</span>
              <span class="flex-1 italic text-white">: ${receipt.terbilang} Rupiah</span>
            </div>
            <div class="flex items-start">
              <span class="w-36 font-semibold text-white">Pembayaran</span>
              <span class="flex-1 text-white">: ${receipt.untuk_pembayaran}</span>
            </div>
          </div>
        </div>
      `;
      
      return card;
    }

    // Update receipt list
    function updateReceiptList(data) {
      const listContainer = document.getElementById('receipt-list');
      const emptyState = document.getElementById('empty-state');
      const countBadge = document.getElementById('receipt-count');
      const printAllBtn = document.getElementById('print-all-btn');
      const selectModeBtn = document.getElementById('select-mode-btn');
      
      receipts = [...data].sort((a, b) => b.no_seri - a.no_seri);
      currentRecordCount = receipts.length;
      
      countBadge.textContent = `${currentRecordCount} kwitansi`;
      
      // Update dashboard stats
      updateDashboardStats();
      
      // Show/hide print all button and select mode button
      if (currentRecordCount > 0) {
        if (!isSelectMode) {
          printAllBtn.classList.remove('hidden');
        }
        selectModeBtn.classList.remove('hidden');
      } else {
        printAllBtn.classList.add('hidden');
        selectModeBtn.classList.add('hidden');
      }
      
      // Check limit
      const limitWarning = document.getElementById('limit-warning');
      if (currentRecordCount >= 999) {
        limitWarning.classList.remove('hidden');
      } else {
        limitWarning.classList.add('hidden');
      }
      
      if (receipts.length === 0) {
        emptyState.classList.remove('hidden');
        // Remove all receipt cards
        const cards = listContainer.querySelectorAll('[data-id]');
        cards.forEach(card => card.remove());
        return;
      }
      
      emptyState.classList.add('hidden');
      
      // Get existing cards
      const existingCards = new Map();
      listContainer.querySelectorAll('[data-id]').forEach(card => {
        existingCards.set(card.dataset.id, card);
      });
      
      // Update or create cards
      const receiptIds = new Set(receipts.map(r => r.__backendId));
      
      // Remove cards that no longer exist
      existingCards.forEach((card, id) => {
        if (!receiptIds.has(id)) {
          card.remove();
        }
      });
      
      // Add new cards
      receipts.forEach(receipt => {
        if (!existingCards.has(receipt.__backendId)) {
          const card = createReceiptCard(receipt);
          listContainer.appendChild(card);
        }
      });
    }

    // Update dashboard statistics
    function updateDashboardStats() {
      const totalReceipts = document.getElementById('total-receipts');
      const totalAmount = document.getElementById('total-amount');
      const latestReceipt = document.getElementById('latest-receipt');
      
      // Total receipts
      totalReceipts.textContent = receipts.length;
      
      // Total amount
      const sum = receipts.reduce((acc, r) => acc + (r.uang_sejumlah || 0), 0);
      totalAmount.textContent = formatCurrency(sum);
      
      // Latest receipt
      if (receipts.length > 0) {
        const latest = receipts[0];
        latestReceipt.textContent = `No. ${String(latest.no_seri).padStart(4, '0')}`;
      } else {
        latestReceipt.textContent = '-';
      }
    }

    // Confirm delete with inline UI
    function confirmDelete(id) {
      const card = document.querySelector(`[data-id="${id}"]`);
      const deleteBtn = card.querySelector('.delete-btn');
      
      deleteBtn.innerHTML = '‚úì Yakin?';
      deleteBtn.style.background = '#d63031';
      deleteBtn.style.color = '#fff';
      deleteBtn.onclick = () => deleteReceipt(id);
      
      setTimeout(() => {
        if (deleteBtn) {
          deleteBtn.innerHTML = 'üóëÔ∏è';
          deleteBtn.style.background = 'rgba(239, 68, 68, 0.2)';
          deleteBtn.style.border = '1px solid rgba(239, 68, 68, 0.4)';
          deleteBtn.style.color = '';
          deleteBtn.onclick = () => confirmDelete(id);
        }
      }, 3000);
    }

    // Print receipt
    function printReceipt(id) {
      const receipt = receipts.find(r => r.__backendId === id);
      if (!receipt) return;
      
      const companyName = config.company_name || defaultConfig.company_name;
      const companyAddress = config.company_address || defaultConfig.company_address;
      const signatureLocation = config.signature_location || defaultConfig.signature_location;
      const signatureName = config.signature_name || defaultConfig.signature_name;
      const signaturePhone = config.signature_phone || defaultConfig.signature_phone;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Kwitansi No. ${String(receipt.no_seri).padStart(4, '0')}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Times New Roman', serif; padding: 10px; max-width: 210mm; margin: 0 auto; background: #f5f5f0; }
            .receipt { 
              border: 2px solid #2c5f2d; 
              padding: 12px 16px; 
              width: 100%; 
              display: block; 
              margin-bottom: 10px; 
              box-sizing: border-box;
              background: linear-gradient(135deg, #fef8e7 0%, #fefcf3 50%, #fef8e7 100%);
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .header { 
              text-align: center; 
              border-bottom: 2px solid #2c5f2d; 
              padding-bottom: 6px; 
              margin-bottom: 8px;
              background: linear-gradient(to bottom, #e8f5e9 0%, transparent 100%);
              padding-top: 4px;
            }
            .header h1 { font-size: 16px; margin-bottom: 3px; font-weight: bold; color: #1b4332; }
            .header p { font-size: 14px; color: #2c5f2d; }
            .title { 
              text-align: center; 
              font-size: 20px; 
              font-weight: bold; 
              margin: 8px 0; 
              text-decoration: underline; 
              color: #1b4332;
              text-transform: uppercase;
              letter-spacing: 2px;
            }
            .no-seri { 
              text-align: right; 
              font-size: 13px; 
              margin-bottom: 8px; 
              color: #d32f2f; 
              font-weight: bold;
            }
            .content { margin: 8px 0; }
            .row { display: flex; margin: 5px 0; font-size: 14px; }
            .label { width: 110px; font-weight: bold; color: #1b4332; }
            .value { 
              flex: 1; 
              border-bottom: 1px dotted #2c5f2d; 
              padding-left: 5px; 
              font-size: 14px; 
              color: #000;
            }
            .terbilang { 
              background: linear-gradient(to right, #c8e6c9 0%, #e8f5e9 50%, #c8e6c9 100%); 
              padding: 6px; 
              margin: 8px 0; 
              font-style: italic; 
              text-align: center; 
              font-size: 13px;
              border: 1px dashed #2c5f2d;
              color: #1b4332;
              font-weight: 500;
            }
            .footer { display: flex; justify-content: flex-end; margin-top: 16px; font-size: 14px; }
            .signature { text-align: center; width: 120px; }
            .signature-line { 
              border-bottom: 1px solid #1b4332; 
              height: 40px; 
              margin-bottom: 3px; 
            }
            .print-btn { 
              position: fixed; 
              top: 20px; 
              right: 20px; 
              padding: 12px 24px; 
              background: #2c5f2d; 
              color: white; 
              border: none; 
              border-radius: 8px; 
              font-size: 16px; 
              cursor: pointer; 
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
              z-index: 1000;
            }
            .print-btn:hover { background: #1b4332; }
            .print-btn:active { transform: scale(0.95); }
            @media print {
              .print-btn { display: none; }
              @page { size: A4; margin: 10mm; }
              body { background: white; }
            }
          </style>
        </head>
        <body>
          <button class="print-btn" onclick="window.print(); return false;">üñ®Ô∏è Cetak Kwitansi</button>
          <div class="receipt">
            <div class="header">
              <h1>${companyName}</h1>
              <p>${companyAddress}</p>
            </div>
            <div class="no-seri">No: ${String(receipt.no_seri).padStart(4, '0')}</div>
            <div class="title">KWITANSI</div>
            <div class="content">
              <div class="row">
                <span class="label">Telah diterima dari</span>
                <span class="value">${receipt.diterima_dari}</span>
              </div>
              <div class="row">
                <span class="label">Uang sejumlah</span>
                <span class="value">${formatCurrency(receipt.uang_sejumlah)}</span>
              </div>
              <div class="terbilang"># ${receipt.terbilang} Rupiah #</div>
              <div class="row">
                <span class="label">Untuk pembayaran</span>
                <span class="value">${receipt.untuk_pembayaran}</span>
              </div>
            </div>
            <div style="text-align: right; margin-top: 8px; font-size: 13px;">
              ${signatureLocation}, ${formatDate(receipt.tanggal)}
            </div>
            <div class="footer">
              <div class="signature">
                <div class="signature-line"></div>
                <span style="font-size: 14px;">${signatureName}</span>
                ${signaturePhone ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">${signaturePhone}</div>` : ''}
              </div>
            </div>
          </div>
          <script>
            // Pastikan tombol bekerja setelah halaman dimuat
            window.onload = function() {
              var btn = document.querySelector('.print-btn');
              if (btn) {
                btn.onclick = function(e) {
                  e.preventDefault();
                  window.print();
                  return false;
                };
              }
            };
          <\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    // Print all receipts
    function printAllReceipts() {
      if (receipts.length === 0) return;
      
      const companyName = config.company_name || defaultConfig.company_name;
      const companyAddress = config.company_address || defaultConfig.company_address;
      const signatureLocation = config.signature_location || defaultConfig.signature_location;
      const signatureName = config.signature_name || defaultConfig.signature_name;
      const signaturePhone = config.signature_phone || defaultConfig.signature_phone;
      
      // Generate all receipts HTML
      const receiptsHTML = receipts.map(receipt => `
          <div class="receipt">
            <div class="header">
              <h1>${companyName}</h1>
              <p>${companyAddress}</p>
            </div>
            <div class="no-seri">No: ${String(receipt.no_seri).padStart(4, '0')}</div>
            <div class="title">KWITANSI</div>
            <div class="content">
              <div class="row">
                <span class="label">Telah diterima dari</span>
                <span class="value">${receipt.diterima_dari}</span>
              </div>
              <div class="row">
                <span class="label">Uang sejumlah</span>
                <span class="value">${formatCurrency(receipt.uang_sejumlah)}</span>
              </div>
              <div class="terbilang"># ${receipt.terbilang} Rupiah #</div>
              <div class="row">
                <span class="label">Untuk pembayaran</span>
                <span class="value">${receipt.untuk_pembayaran}</span>
              </div>
            </div>
            <div style="text-align: right; margin-top: 8px; font-size: 13px;">
              ${signatureLocation}, ${formatDate(receipt.tanggal)}
            </div>
            <div class="footer">
              <div class="signature">
                <div class="signature-line"></div>
                <span style="font-size: 14px;">${signatureName}</span>
                ${signaturePhone ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">${signaturePhone}</div>` : ''}
              </div>
            </div>
          </div>
      `).join('');
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Daftar Kwitansi (${receipts.length} kwitansi)</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Times New Roman', serif; padding: 10px; max-width: 210mm; margin: 0 auto; background: #f5f5f0; }
            .receipt { 
              border: 2px solid #2c5f2d; 
              padding: 12px 16px; 
              width: 100%; 
              display: block; 
              margin-bottom: 10px; 
              box-sizing: border-box;
              background: linear-gradient(135deg, #fef8e7 0%, #fefcf3 50%, #fef8e7 100%);
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .header { 
              text-align: center; 
              border-bottom: 2px solid #2c5f2d; 
              padding-bottom: 6px; 
              margin-bottom: 8px;
              background: linear-gradient(to bottom, #e8f5e9 0%, transparent 100%);
              padding-top: 4px;
            }
            .header h1 { font-size: 16px; margin-bottom: 3px; font-weight: bold; color: #1b4332; }
            .header p { font-size: 14px; color: #2c5f2d; }
            .title { 
              text-align: center; 
              font-size: 20px; 
              font-weight: bold; 
              margin: 8px 0; 
              text-decoration: underline; 
              color: #1b4332;
              text-transform: uppercase;
              letter-spacing: 2px;
            }
            .no-seri { 
              text-align: right; 
              font-size: 13px; 
              margin-bottom: 8px; 
              color: #d32f2f; 
              font-weight: bold;
            }
            .content { margin: 8px 0; }
            .row { display: flex; margin: 5px 0; font-size: 14px; }
            .label { width: 110px; font-weight: bold; color: #1b4332; }
            .value { 
              flex: 1; 
              border-bottom: 1px dotted #2c5f2d; 
              padding-left: 5px; 
              font-size: 14px; 
              color: #000;
            }
            .terbilang { 
              background: linear-gradient(to right, #c8e6c9 0%, #e8f5e9 50%, #c8e6c9 100%); 
              padding: 6px; 
              margin: 8px 0; 
              font-style: italic; 
              text-align: center; 
              font-size: 13px;
              border: 1px dashed #2c5f2d;
              color: #1b4332;
              font-weight: 500;
            }
            .footer { display: flex; justify-content: flex-end; margin-top: 16px; font-size: 14px; }
            .signature { text-align: center; width: 120px; }
            .signature-line { 
              border-bottom: 1px solid #1b4332; 
              height: 40px; 
              margin-bottom: 3px; 
            }
            .print-btn { 
              position: fixed; 
              top: 20px; 
              right: 20px; 
              padding: 12px 24px; 
              background: #2c5f2d; 
              color: white; 
              border: none; 
              border-radius: 8px; 
              font-size: 16px; 
              cursor: pointer; 
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
              z-index: 1000;
            }
            .print-btn:hover { background: #1b4332; }
            .print-btn:active { transform: scale(0.95); }
            @media print {
              .receipt { page-break-after: always; }
              .receipt:last-child { page-break-after: auto; }
              .print-btn { display: none; }
              @page { size: A4; margin: 10mm; }
              body { background: white; }
            }
          </style>
        </head>
        <body>
          <button class="print-btn" id="printBtn">üñ®Ô∏è Cetak Semua Kwitansi</button>
          ${receiptsHTML}
          <script>
            window.onload = function() {
              var btn = document.getElementById('printBtn');
              if (btn) {
                btn.onclick = function(e) {
                  e.preventDefault();
                  window.print();
                  return false;
                };
              }
            };
          <\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    // Show toast message
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-6 right-6 px-6 py-4 rounded-2xl shadow-2xl transform transition-all z-50 glass-effect font-medium';
      toast.style.cssText = type === 'error' 
        ? 'background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.9) 100%); color: white; border: 1px solid rgba(239, 68, 68, 0.5);' 
        : 'background: linear-gradient(135deg, rgba(34, 197, 94, 0.9) 0%, rgba(22, 163, 74, 0.9) 100%); color: white; border: 1px solid rgba(34, 197, 94, 0.5);';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(20px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Settings form submission
    document.getElementById('settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const newTitle = document.getElementById('settings-title').value.trim();
      const newCompany = document.getElementById('settings-company').value.trim();
      const newAddress = document.getElementById('settings-address').value.trim();
      const newLocation = document.getElementById('settings-location').value.trim();
      const newSignatureName = document.getElementById('settings-signature-name').value.trim();
      const newSignaturePhone = document.getElementById('settings-signature-phone').value.trim();
      
      const newConfig = {
        kwitansi_title: newTitle || defaultConfig.kwitansi_title,
        company_name: newCompany || defaultConfig.company_name,
        company_address: newAddress || defaultConfig.company_address,
        signature_location: newLocation || defaultConfig.signature_location,
        signature_name: newSignatureName || defaultConfig.signature_name,
        signature_phone: newSignaturePhone
      };
      
      // Save to localStorage
      saveConfigToStorage(newConfig);
      
      // Apply changes
      await onConfigChange(newConfig);
      
      toggleSettings();
      showToast('Pengaturan berhasil disimpan! ‚ú®');
    });

    // Form submission
    document.getElementById('receipt-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (currentRecordCount >= 999) {
        showToast('Batas maksimum 999 kwitansi tercapai', 'error');
        return;
      }
      
      const btnText = document.getElementById('btn-text');
      const btnLoading = document.getElementById('btn-loading');
      const submitBtn = document.getElementById('submit-btn');
      
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
      submitBtn.disabled = true;
      
      const diterimaDari = document.getElementById('diterima-dari').value.trim();
      const uangSejumlah = parseInt(document.getElementById('uang-sejumlah').value) || 0;
      const untukPembayaran = document.getElementById('untuk-pembayaran').value.trim();
      
      const newReceipt = {
        no_seri: getNextSerialNumber(),
        diterima_dari: diterimaDari,
        uang_sejumlah: uangSejumlah,
        terbilang: terbilang(uangSejumlah).trim(),
        untuk_pembayaran: untukPembayaran,
        tanggal: new Date().toISOString()
      };
      
      let result;
      if (window.dataSdk) {
        result = await window.dataSdk.create(newReceipt);
      } else {
        result = { isOk: false };
      }
      
      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
      submitBtn.disabled = false;
      
      if (result.isOk) {
        document.getElementById('receipt-form').reset();
        showToast('Kwitansi berhasil dibuat! ‚ú®');
      } else {
        showToast('Gagal membuat kwitansi', 'error');
      }
    });

    // Update delete receipt function
    async function deleteReceipt(id) {
      const receipt = receipts.find(r => r.__backendId === id);
      if (!receipt) return;
      
      const card = document.querySelector(`[data-id="${id}"]`);
      if (card) {
        card.style.opacity = '0.5';
        card.style.pointerEvents = 'none';
      }
      
      let result;
      if (window.dataSdk) {
        result = await window.dataSdk.delete(receipt);
      } else {
        result = { isOk: false };
      }
      
      if (!result.isOk) {
        if (card) {
          card.style.opacity = '1';
          card.style.pointerEvents = 'auto';
        }
        showToast('Gagal menghapus kwitansi', 'error');
      }
    }

    // Config change handler
    async function onConfigChange(newConfig) {
      config = { ...defaultConfig, ...newConfig };
      
      // Save to localStorage whenever config changes
      saveConfigToStorage(config);
      
      // Update title
      const titleText = document.getElementById('title-text');
      if (titleText) {
        titleText.textContent = config.kwitansi_title || defaultConfig.kwitansi_title;
      }
      
      // Update company name display in all cards
      const cards = document.querySelectorAll('[data-id]');
      cards.forEach(card => {
        const companyText = card.querySelector('p.text-sm');
        if (companyText) {
          companyText.textContent = config.company_name || defaultConfig.company_name;
        }
      });
    }
    
    // Initialize display with saved config
    function initializeDisplay() {
      // Update title on page load
      const titleText = document.getElementById('title-text');
      if (titleText) {
        titleText.textContent = config.kwitansi_title || defaultConfig.kwitansi_title;
      }
    }
    
    // Call initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initializeDisplay();
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c5e6bf0075eb5ca',t:'MTc2OTc0OTM5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
